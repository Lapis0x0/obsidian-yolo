name: Prepare Release

on:
  push:
    branches:
      - 'release/**'

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          # 使用 PAT 以便后续 push 可以触发其他工作流
          # 如果使用默认 GITHUB_TOKEN，push 不会触发 release.yml
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Extract version from branch name
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          VERSION="${BRANCH_NAME#release/}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Extracted version: $VERSION"

      - name: Validate version format
        run: |
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: x.y.z or x.y.z-beta.1"
            exit 1
          fi

      - name: Update version numbers
        run: npm run version $VERSION

      - name: Commit version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json package.json versions.json
          git commit -m "chore: bump version to $VERSION"

      - name: Determine target branch
        run: |
          major_minor=$(echo "$VERSION" | awk -F. '{print $1"."$2}')
          candidate_branch="${major_minor}.x"
          if git ls-remote --exit-code --heads origin "$candidate_branch" >/dev/null 2>&1; then
            echo "TARGET_BRANCH=$candidate_branch" >> $GITHUB_ENV
          else
            echo "TARGET_BRANCH=main" >> $GITHUB_ENV
          fi
          echo "Target branch: ${TARGET_BRANCH:-main}"

      - name: Create and push tag
        run: |
          git tag "$VERSION"
          git push origin "$VERSION"
          echo "Tag $VERSION created and pushed"

      - name: Create version bump PR
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: bump version to ${{ env.VERSION }}'
          title: 'Version bump: ${{ env.VERSION }}'
          body: |
            自动版本号更新 PR

            - 版本号：${{ env.VERSION }}
            - 目标分支：${{ env.TARGET_BRANCH }}

            此 PR 由 prepare-release 工作流自动创建。
            tag ${{ env.VERSION }} 已推送，release 工作流应该正在运行。

            请检查 release 是否成功创建后再合并此 PR。
          branch: 'version-bump/${{ env.VERSION }}'
          base: '${{ env.TARGET_BRANCH }}'
          delete-branch: true

      - name: Delete release branch
        run: |
          git push origin --delete "release/$VERSION" || true
          echo "Release branch deleted"
